stages:
  - compile
  - test
  - run

variables:
  TEST_RUN_BOARD_SIZE: 11
  TEST_RUN_MAX_RUNNING_TIME: 60

include:
  - template: Code-Quality.gitlab-ci.yml
  - template: Security/SAST.gitlab-ci.yml

.PrepareSBT:
  image: ubuntu:20.04
  before_script:
    - apt-get -y update
    - apt-get -y upgrade
    - apt-get -y install curl gnupg openjdk-16-jdk
    - echo "deb https://repo.scala-sbt.org/scalasbt/debian all main" > /etc/apt/sources.list.d/sbt.list
    - echo "deb https://repo.scala-sbt.org/scalasbt/debian /" > /etc/apt/sources.list.d/sbt_old.list
    - curl -sL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x2EE0EA64E40A89B84B2DF73499E82A75642AC823" | apt-key add
    - apt-get -y update
    - apt-get -y install sbt

Compile:
  extends: .PrepareSBT
  stage: compile
  needs: []
  script:
    - sbt compile

Test:
  extends: .PrepareSBT
  stage: test
  needs:
    - Compile
  script:
    - sbt test

Run:
  extends: .PrepareSBT
  stage: test
  needs:
    - Compile
  script:
    - sbt run

# The following ones use a prepared docker image. They run somewhat faster, but not all that much.
# I'll decide later whether to drop one of the ways to install sbt, or keep them both (for some
# variety in how the build is done, and potentially more cross-compatibility.)
Compile:UseSbtDocker:
  image: hseeberger/scala-sbt:8u222_1.3.5_2.13.1
  stage: compile
  needs: []
  script:
    - sbt compile

Test:UseSbtDocker:
  image: hseeberger/scala-sbt:8u222_1.3.5_2.13.1
  stage: test
  needs:
    - Compile:UseSbtDocker
  script:
    - sbt test
  artifacts:
    when: always
    reports:
      junit: target/test-reports/**/TEST-*.xml

Run:UseSbtDocker:
  image: hseeberger/scala-sbt:8u222_1.3.5_2.13.1
  stage: test
  needs:
    - Compile:UseSbtDocker
  script:
    - sbt run

CheckRunTime:UseSbtDocker:
  image: hseeberger/scala-sbt:8u222_1.3.5_2.13.1
  stage: test
  needs: []
  before_script:
    - apt-get -y update
    - apt-get -y install bc time
  script:
    - sbt compile
    - /usr/bin/time -f %U -o runtime.log sbt "run $TEST_RUN_BOARD_SIZE"
    - echo "$(<runtime.log) > $TEST_RUN_MAX_RUNNING_TIME"
    - if [ $(echo "$(<runtime.log) > $TEST_RUN_MAX_RUNNING_TIME" | bc -l) -eq 1 ]; then exit 1; fi